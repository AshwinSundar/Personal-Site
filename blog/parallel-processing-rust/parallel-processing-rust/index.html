<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.12.1"/><style data-href="/styles.82e69b44b15d8cc1e904.css" data-identity="gatsby-global-css">@font-face{font-family:Bebas Neue;src:url(/static/BebasNeue-Regular-12e3683f9192436a7be8e24657809a1f.ttf)}@font-face{font-family:Zen Kurenaido;src:url(/static/ZenKurenaido-Regular-61210c17444b93cbf5024f337f5c9e85.ttf)}@font-face{font-family:Radio Canada Light;src:url(/static/RadioCanada-Light-b62fc0a54e8dbd4ef19adb46d1ef4d1e.ttf)}@font-face{font-family:Radio Canada Regular;src:url(/static/RadioCanada-Regular-d27e1bceccc9fe2a33dedd8a27170f39.ttf)}@font-face{font-family:Radio Canada Medium;src:url(/static/RadioCanada-Medium-5e4c7e2f1eb9825b27993a6c2e3d9ca4.ttf)}@font-face{font-family:Radio Canada Semi-Bold;src:url(/static/RadioCanada-SemiBold-a780beaeb4ce6a1c849d25cc5322419f.ttf)}@font-face{font-family:Radio Canada Bold;src:url(/static/RadioCanada-Bold-003039c700c6d5ff6a1f6a7572680dd1.ttf)}.layout-module--container--RoCXy{font-family:Radio Canada Regular}.layout-module--site-title--WxIkt{font-family:Bebas Neue;font-size:3rem;font-weight:700;margin:3rem 1vw}.layout-module--site-title--WxIkt>*{color:gray;text-decoration:none}.layout-module--heading--3ayl9{color:#404040}.layout-module--main--ay8oo{display:flex}.layout-module--main--ay8oo .layout-module--content--FwTjf{display:flex;flex-direction:column;width:100%}.content-module--content--UHy8y{background-color:#f3f3f3;font-family:Radio Canada Regular;font-size:16px;line-height:20px;padding:0 1vw}.navbar-module--nav-links--BXv-J{display:flex;list-style:none;margin:1vw;padding-left:0}.navbar-module--nav-link-item--\+edZw{padding-right:2rem}.navbar-module--nav-link-item--\+edZw .navbar-module--nav-link-text--gFFqA{color:#c2901d;text-decoration:none}.bio-module--bio--va264 .bio-module--text--fkZqR{color:gray;padding:10px 0}.bio-module--strong--kCV3I{color:#000}.blog-module--date--cLSN7{color:gray;font-style:italic}.musicPlayer-module--music-player-container--C4R\+5{display:flex;flex-direction:column}.musicPlayer-module--music-player-container--C4R\+5 .musicPlayer-module--content-container--PYalc{display:flex;flex-direction:row;justify-content:space-between}.musicPlayer-module--music-player-container--C4R\+5 .musicPlayer-module--content-container--PYalc .musicPlayer-module--left-container--1Qfqa .musicPlayer-module--play--qWwYo{cursor:pointer}.mainDisplay-module--main-display--iNTDA{display:flex;flex-direction:column}.mainDisplay-module--main-display--iNTDA .mainDisplay-module--bottom--Fq91s{display:flex;flex-direction:row}.thinHeader-module--thin-header--zRgMp{background-color:#404040;width:100%}.thinHeader-module--thin-header--zRgMp .thinHeader-module--text--aAUJp{-moz-text-fill-color:transparent;-webkit-text-fill-color:transparent;background:linear-gradient(red,#ff0);background-clip:text;-webkit-background-clip:text;-moz-background-clip:text;text-align:center}.playlist-module--playlist--ft6Td table{background-color:#000;color:#fff;cursor:pointer;user-select:none;-webkit-user-select:none;-ms-user-select:none;-moz-user-select:none}.playlist-module--playlist--ft6Td th{text-align:left}.playlist-module--playlist--ft6Td tr{color:#3f3}.playlist-module--playlist--ft6Td tr:hover{color:#fff}.playlist-module--playlist--ft6Td tr:nth-child(2n){background-color:#191919}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link as="script" rel="preload" href="/webpack-runtime-02e30fcd626d9bcf9991.js"/><link as="script" rel="preload" href="/framework-6710801b7d89d7dbe869.js"/><link as="script" rel="preload" href="/app-c0d591f35b1cc4cc245a.js"/><link as="script" rel="preload" href="/component---src-pages-blog-mdx-slug-tsx-d2a76146f2b99d8c05b4.js"/><link as="fetch" rel="preload" href="/page-data/blog/parallel-processing-rust/parallel-processing-rust/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2928772754.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--container--RoCXy"><title class="layout-module--site-title--WxIkt">Parallel Processing in Rust<!-- --> | <!-- -->Ashwin Sundar</title><header class="layout-module--site-title--WxIkt"><a href="/">Ashwin Sundar</a></header><nav><ul class="navbar-module--nav-links--BXv-J"><li class="navbar-module--nav-link-item--+edZw"><a class="navbar-module--nav-link-text--gFFqA" href="/">Writing</a></li><li class="navbar-module--nav-link-item--+edZw"><a class="navbar-module--nav-link-text--gFFqA" href="/music">Music</a></li><li class="navbar-module--nav-link-item--+edZw">Photography</li><li class="navbar-module--nav-link-item--+edZw">Work</li><li class="navbar-module--nav-link-item--+edZw">About Me</li><li class="navbar-module--nav-link-item--+edZw"><a class="navbar-module--nav-link-text--gFFqA" href="/future_projects">Future Projects</a></li></ul></nav><main class="layout-module--main--ay8oo"><div class="layout-module--content--FwTjf"><div class="content-module--content--UHy8y"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper gatsby-image-wrapper-constrained"><div style="max-width:0;display:block"><img alt="" role="presentation" aria-hidden="true" src="data:image/svg+xml;charset=utf-8,%3Csvg height=&#x27;0&#x27; width=&#x27;0&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; version=&#x27;1.1&#x27;%3E%3C/svg%3E" style="max-width:100%;display:block;position:static"/></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear"></div><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" decoding="async" loading="lazy" alt=""/><noscript><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" decoding="async" loading="lazy" alt=""/></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1)}}</script></div><p class="blog-module--date--cLSN7">April 2022</p><p><a href="https://www.rust-lang.org/">Rust</a> is a systems programming language that is quickly gaining traction at well-known companies including Amazon, Discord, Dropbox, Meta, Alphabet, and Microsoft. It is built for <a href="https://www.rust-lang.org/">performance, reliability, and productivity</a> and has been voted the most loved programming language according to Stack Overflow&#x27;s <a href="https://insights.stackoverflow.com/survey">Annual Developer Survey</a> since 2016. Some large-scale commercial projects that have been built using Rust include:</p><ul><li>Mozilla&#x27;s <a href="https://servo.org/">Servo</a> parallel browser engine</li><li>Discord&#x27;s <a href="https://blog.discord.com/why-discord-is-switching-from-go-to-rust-a190bbca2b1f">Read States</a> service</li><li>Polkadot&#x27;s <a href="https://github.com/paritytech/polkadot">Substrate</a> blockchain engine</li><li>Figma&#x27;s <a href="https://www.figma.com/blog/rust-in-production-at-figma/">Multiplayer</a> service</li></ul><p>All of these real-world use cases of Rust utilize and benefit from concurrent and parallel processing, which can be daunting to implement on a good day, and pretty terrifying when implemented <a href="https://en.wikipedia.org/wiki/Therac-25">badly</a>. Rust helps mitigate concurrency hazards by design, but it&#x27;s still up to the programmer to construct their program logic thoughtfully so they can take advantage of the power of concurrent and parallel processing.</p><p><strong>When should I use concurrent or parallel processing, instead of serial processing?</strong></p><p>Most modern processors have multiple cores to work with, which means you can use these cores to achieve significant performance gains:</p><ul><li>When you have a lot of independent computations to process, such as a giant for-loop.</li><li>When some of your threads contain computations that are particularly lengthy to calculate. It&#x27;s nice to run these on the &quot;backburner&quot; without blocking your program from performing other computations.</li><li>When you have low <a href="https://www.mathworks.com/help/parallel-computing/decide-when-to-use-parfor.html">parallel overhead</a></li></ul><p><strong>How do I implement parallel processing in Rust?</strong>
My favorite way to learn new programming languages is by combining it with my love for math and solving problems in <a href="https://projecteuler.net/">Project Euler</a>. To demonstrate parallelization in Rust, let&#x27;s solve a <a href="https://projecteuler.net/problem=1">simple problem</a> that I tweaked slightly so we can focus on the implementation of our solution:</p><p><em>If we list all the natural numbers below 10 that are multiples of 3 or 5, we get 3, 5, 6 and 9. The sum of these multiples is 23. Find the sum of all the multiples of 3 or 5 below 1,000,000.</em></p><p><strong>Solution Methodology</strong>
While the mathematically elegant solution would be to use an <a href="https://en.wikipedia.org/wiki/Arithmetic_progression">arithmetic series</a>, let&#x27;s just focus on the simple solution, which is to figure out if each number in the range is divisible by 3 or 5. If it is, let&#x27;s add it to a running sum we&#x27;re keeping track of.</p><p><strong>Example 1 - No parallelization</strong></p><deckgo-highlight-code language="rust" terminal="none">
          <code slot="code">fn euler1_unpar(input: i32) -&gt; i64 {
    let mut sum: i64 = 0;
    for i in 1..input {
        if i % 3 == 0 || i % 5 == 0 {
            sum += i as i64;
        }
    }
    sum
}</code>
        </deckgo-highlight-code><p><strong>Code walkthrough:</strong> In this example, we accept an <code>input</code>, and iterate on every number between <code>1..input</code> to determine if it is divisible by 3 or 5 using the modulo <code>%</code> operator. If it is, then add the value to a running <code>sum</code> we&#x27;re keeping track of. At the end, return the sum. In Rust, you can return a value by simply calling it without a semicolon after the expression. Since Rust is a <a href="https://en.wikipedia.org/wiki/Strong_and_weak_typing">strongly-typed</a> language, we need to tell the compiler to add the original <code>i32</code> input and convert the sum to an <code>i64</code>, so that we have enough space to store the answer.</p><p>Let&#x27;s calculate a performance benchmark for this function so we can compare it to our multithreaded optimization that we&#x27;ll write next. We can calculate this benchmark with the <a href="https://docs.rs/easybench/latest/easybench/">easybench</a> crate, an importable package in Rust.</p><deckgo-highlight-code language="rust" terminal="none">
          <code slot="code">use easybench::{bench};
let input = 1000000;
println!(&quot;euler1_unpar: {}&quot;, bench(|| euler1_unpar(input) ) );

&gt;&gt; euler1_unpar: 14.429298ms (R²=0.999, 70 iterations in 21 samples)</code>
        </deckgo-highlight-code><p>Our unparallelized function takes about <code>14.4</code> milliseconds to execute.</p><p><strong>Example 2 - Parallelized (2 threads)</strong></p><deckgo-highlight-code language="rust" terminal="none">
          <code slot="code">fn euler1_par(input: i32) -&gt; i64 {
    use std::thread;

    let handle1 = thread::spawn(move || {
        let mut thread1_sum: i64 = 0;
        for i in 1..input / 2 {
            if i % 3 == 0 || i % 5 == 0 {
                thread1_sum += i as i64;
            }
        }

        thread1_sum
    });

    let handle2 = thread::spawn(move || {
        let mut thread2_sum: i64 = 0;

        for i in (input / 2)..input {
            if i % 3 == 0 || i % 5 == 0 {
                thread2_sum += i as i64;
            }
        }

        thread2_sum
    });

    handle1.join().unwrap() + handle2.join().unwrap()
}</code>
        </deckgo-highlight-code><p><strong>Code walkthrough:</strong> Here, we use the <code>thread</code> module so that we can take advantage of the native multithreading available in Rust. A new thread is created by calling <code>thread::spawn</code>, into which a <code>closure</code> is passed. <a href="https://doc.rust-lang.org/book/ch13-01-closures.html">Closures</a> are anonymous functions that allow you to access environment variables, such as the <code>input</code> variable. This closure does the same mathematical computation as <code>euler1_unpar</code>, except we only process one half of the total range in the thread. The other half is saved for the second thread. We also need to <code>move</code> a copy of the input into the closure&#x27;s scope so that the thread can take ownership of the data and use it. Writing code like this can seem tedious and time-consuming, but is required by Rust to help reduce the risk of <a href="https://doc.rust-lang.org/book/ch16-00-concurrency.html">concurrency errors</a>.</p><p><code>thread::spawn</code> returns a <code>JoinHandle</code> type, which contains some convenience methods that allow us to take back control over the threads and handle their results. In this case, <code>JoinHandle::join()</code> halts execution of the function until our threads have finished their calculations. <code>.unwrap()</code> exposes the answers we&#x27;ve calculated in each thread, and then finally we sum those answers up.</p><p>Let&#x27;s see how long this function takes to run:</p><deckgo-highlight-code terminal="none">
          <code slot="code">use easybench::{bench};
let input = 1000000;
println!(&quot;{}&quot;, euler1_par(input));

&gt; euler1_par:  7.345441ms (R²=0.998, 133 iterations in 27 samples)</code>
        </deckgo-highlight-code><p>The parallelized function takes about <code>7.3</code> milliseconds to execute.</p><p><strong>Conclusion</strong>
The parallelized code runs almost twice as fast as our unparallelized code, and we seem to only lose a little performance due to the overhead of setting up the threads. Nice!</p><p>This example demonstrates a way to get started with parallel processing in Rust. You often need to design your program with parallelization in mind from the get-go, as you are forced to think about the flow of your code and determine what pieces of the code take the longest to run and would benefit from parallelization.</p><p><em>This article was originally written for the <a href="https://engineering.deptagency.com/parallel-processing-in-rust">engineering blog</a> at DEPT®, a technology consultancy</em></p></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/parallel-processing-rust/parallel-processing-rust/";window.___webpackCompilationHash="e7aadee53d914d63055b";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c8708dfa47b60eb3e462.js"],"app":["/app-c0d591f35b1cc4cc245a.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-e1ccf424990858934a81.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-45e816bb4133cf954caf.js"],"component---src-pages-blog-index-tsx":["/component---src-pages-blog-index-tsx-2835f651b5f8539b394d.js"],"component---src-pages-blog-mdx-slug-tsx":["/component---src-pages-blog-mdx-slug-tsx-d2a76146f2b99d8c05b4.js"],"component---src-pages-future-projects-tsx":["/component---src-pages-future-projects-tsx-ab955156a8fea1b3a701.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-356de904b1746dfbd32d.js"],"component---src-pages-music-tsx":["/component---src-pages-music-tsx-848f03b26fb66765434e.js"]};/*]]>*/</script><script src="/polyfill-c8708dfa47b60eb3e462.js" nomodule=""></script><script src="/component---src-pages-blog-mdx-slug-tsx-d2a76146f2b99d8c05b4.js" async=""></script><script src="/app-c0d591f35b1cc4cc245a.js" async=""></script><script src="/framework-6710801b7d89d7dbe869.js" async=""></script><script src="/webpack-runtime-02e30fcd626d9bcf9991.js" async=""></script></body></html>